import{isMainThread as S}from"node:worker_threads";import{i as w,a as U,m as D}from"../node-features-Dcn4STxq.mjs";import{r as M}from"../register-B0bfVVOZ.mjs";import{l,c as u,e as A,i as _,f as I,g as E,h as P,d as b,r as $,a as L,t as T}from"../resolve-ts-path-DUkQ8uuR.mjs";import{fileURLToPath as k,pathToFileURL as q}from"node:url";import{b as v,t as C}from"../index-CKNv86dv.mjs";import{p as O}from"../client-Cg7nS93t.mjs";import R from"node:path";import N from"node:fs";import"node:module";import"get-tsconfig";import"esbuild";import"node:crypto";import"node:os";import"../temporary-directory-CwHp0_NW.mjs";import"node:net";import"../get-pipe-path-CmcG6VNd.mjs";const m={active:!0},W=async t=>{if(!t)throw new Error(`tsx must be loaded with --import instead of --loader
The --loader flag was deprecated in Node v20.6.0 and v18.19.0`);m.namespace=t.namespace,t.tsconfig!==!1&&l(t.tsconfig??process.env.TSX_TSCONFIG_PATH),t.port&&(m.port=t.port,t.port.on("message",a=>{a==="deactivate"&&(m.active=!1,t.port.postMessage({type:"deactivated"}))}))},G=()=>(l(process.env.TSX_TSCONFIG_PATH),"process.setSourceMapsEnabled(true);"),p=new Map,Q=async t=>{if(p.has(t))return p.get(t);if(!await N.promises.access(t).then(()=>!0,()=>!1)){p.set(t,void 0);return}const r=await N.promises.readFile(t,"utf8");try{const e=JSON.parse(r);return p.set(t,e),e}catch{throw new Error(`Error parsing: ${t}`)}},H=async t=>{let a=new URL("package.json",t);for(;!a.pathname.endsWith("/node_modules/package.json");){const r=k(a),e=await Q(r);if(e)return e;const n=a;if(a=new URL("../package.json",a),a.pathname===n.pathname)break}},X=async t=>(await H(t))?.type??"commonjs",K=t=>{const a=t.indexOf("?");t=a===-1?t:t.slice(0,a);const r=R.extname(t);if(r===".json")return"json";if(r===".mjs"||r===".mts")return"module";if(r===".cjs"||r===".cts")return"commonjs"},x=t=>{const a=K(t);if(a)return a;if(u.test(t))return X(t)},f="tsx-namespace=",d=t=>{const a=t.indexOf(f);if(a===-1)return;const r=t[a-1];if(r!=="?"&&r!=="&")return;const e=a+f.length,n=t.indexOf("&",e);return n===-1?t.slice(e):t.slice(e,n)},g=w(U)?"importAttributes":"importAssertions",z=async(t,a,r)=>{if(!m.active||m.namespace&&m.namespace!==d(t))return r(t,a);if(m.port){const o=new URL(t);o.searchParams.delete("tsx-namespace"),m.port.postMessage({type:"load",url:o.toString()})}O.send&&O.send({type:"dependency",path:t}),A.test(t)&&(a[g]||(a[g]={}),a[g].type="json");const e=await r(t,a);if(!e.source)return e;const n=t.startsWith("file://")?k(t):t,s=e.source.toString();if(e.format==="json"||u.test(t)){const o=await v(s,n,{tsconfigRaw:I?.(n)});return{format:"module",source:_(o)}}if(e.format==="module"){const o=C(n,s);o&&(e.source=_(o))}return e},h=async t=>(!t.format&&t.url.startsWith(L)&&(t.format=await x(t.url)),t),B=[".js",".json",".ts",".tsx",".jsx"],y=async(t,a,r)=>{const[e,n]=t.split("?");let s;for(const o of B)try{return await h(await r(e+o+(n?`?${n}`:""),a))}catch(c){if(s===void 0&&c instanceof Error){const{message:i}=c;c.message=c.message.replace(`${o}'`,"'"),c.stack=c.stack.replace(i,c.message),s=c}}throw s},j=async(t,a,r)=>{const e=P.test(t),n=e?"index":"/index",[s,o]=t.split("?");try{return await y(s+n+(o?`?${o}`:""),a,r)}catch(c){if(!e)try{return await y(t,a,r)}catch{}const i=c,{message:J}=i;throw i.message=i.message.replace(`${n.replace("/",R.sep)}'`,"'"),i.stack=i.stack.replace(J,i.message),i}},F=async(t,a,r,e)=>{if(!m.active)return r(t,a);const n=a.parentURL&&d(a.parentURL);if(E(t)){let s=d(t);if(n&&!s&&(s=n,t+=`${t.includes("?")?"&":"?"}${f}${n}`),m.namespace&&m.namespace!==s)return r(t,a);if(P.test(t))return await j(t,a,r)}else if(T&&!a.parentURL?.includes("/node_modules/")){const s=T(t);for(const o of s)try{return await F(q(o).toString(),a,r)}catch{}}if(u.test(a.parentURL)||b){const s=$(t);if(s)for(const o of s)try{return await h(await r(o,a))}catch(c){const{code:i}=c;if(i!=="ERR_MODULE_NOT_FOUND"&&i!=="ERR_PACKAGE_PATH_NOT_EXPORTED")throw c}}try{const s=await h(await r(t,a));if(E(s.url)){const o=d(s.url);n&&!o&&(s.url+=`${s.url.includes("?")?"&":"?"}${f}${n}`)}return s}catch(s){if(s instanceof Error&&!e){const{code:o}=s;if(o==="ERR_UNSUPPORTED_DIR_IMPORT")try{return await j(t,a,r)}catch(c){if(c.code!=="ERR_PACKAGE_IMPORT_NOT_DEFINED")throw c}if(o==="ERR_MODULE_NOT_FOUND")try{return await y(t,a,r)}catch{}}throw s}};w(D)&&S&&M();export{G as globalPreload,W as initialize,z as load,F as resolve};
